@model WoodWorking.Models.OrderViewModel

@{
    ViewData["Title"] = "Нова поръчка";
}

<h1 class="text-center">Нова поръчка</h1>

<hr />
<div class="container">    
    <form asp-action="New" method="post">        
        <div class="form-group">
            <label asp-for="ClientName" class="control-label" style="font-weight: bold;">Име на клиента:</label>
            <input asp-for="ClientName" class="form-control" style="max-width:350px" />
            <span asp-validation-for="ClientName" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="ClientPhone" class="control-label" style="font-weight: bold;">Телефонен номер:</label>
            <input asp-for="ClientPhone" class="form-control" style="max-width:350px;" />
            <span asp-validation-for="ClientPhone" class="text-danger"></span>
        </div>
        <br />

        <div class="form-group form-check">
            <label class="form-check-label" style="font-weight: bold;">
                <input class="form-check-input" asp-for="IsExpress" style="padding: 15px; margin-right: 10px;" />Експресна поръчка +25%
            </label>
        </div>
        <br />

        <div class="prices" style="font-weight: bold;">
            <div class="form-group">
                Цена за материалите: <input asp-for="MaterialPrice" class="prices-fields" disabled="disabled" style="margin-left: 46px;" /> лв.
            </div>

            <div class="form-group" >
                Цена за кантиране: <input asp-for="EdgePrice" class="prices-fields" disabled="disabled" style="margin-left: 65px;" /> лв.
            </div>

            <div class="form-group">
                Крайна цена: <input asp-for="TotalPrice" class="prices-fields" disabled="disabled" style="margin-left: 113px;" /> лв.
            </div>
        </div>

        <br />

        <table class="table table-condensed table-hover border">
            <thead>
                <tr>
                    <th rowspan="2" style="min-width: 500px;">Материали</th>
                    <th rowspan="2" style="min-width: 60px;">Цена</th>
                    <th rowspan="2" style="min-width: 50px;">Дължина, m</th>
                    <th rowspan="2" style="min-width: 50px;">Широчина, m</th>
                    <th rowspan="2" style="min-width: 60px;">Бр</th>
                    <th rowspan="2" style="min-width: 100px;">Квадратура</th>
                    <th rowspan="2">Цена на материала, лв </th>
                    <th colspan="4" style="min-width: 180px;">Кантиране</th>
                    <th rowspan="2">Цена на кантирането, лв</th>
                </tr>
                <tr>
                    <th style="min-width: 40px;">H</th>
                    <th style="min-width: 40px;">H</th>
                    <th style="min-width: 40px;">L</th>
                    <th style="min-width: 40px;">L</th>
                </tr>
            </thead>
            <tbody> 
                @for (int i = 0; i < 12; i++)
                {
                    <tr>
                        <td>
                            <div class="form-group">
                                <select asp-for="OrderedMaterials[i].MaterialName" onchange="insertPrice(@i);" class="form-control" />
                                    <option></option>
                                    @foreach (var material in Model.Materials)
                                    {
                                        <option value="@material.Id">@material.Name</option>
                                    }
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <select asp-for="OrderedMaterials[i].MaterialPrice" disabled="disabled" class="form-control" />
                                <option></option>
                                @foreach (var material in Model.Materials)
                                {
                                    <option value="@material.Id">@material.Price</option>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <input asp-for="OrderedMaterials[i].MaterialLength" class="form-control" onchange="calculateMaterialPrice(@i);" />
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <input asp-for="OrderedMaterials[i].MaterialHeight" class="form-control" onchange="calculateMaterialPrice(@i);" />
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <input asp-for="OrderedMaterials[i].MaterialQty" class="form-control" onchange="calculateMaterialPrice(@i); calculateEdgePrice(@i);" />
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <input asp-for="OrderedMaterials[i].MaterialQuadrature" class="form-control" disabled="disabled" />
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <input asp-for="OrderedMaterials[i].MaterialTotalPrice" class="form-control" disabled="disabled" />
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <select asp-for="OrderedMaterials[i].MaterialEdgeH1" class="form-control" onchange="calculateEdgePrice(@i);" />
                                <option value="0"></option>
                                @foreach (var edge in Model.Edges)
                                {
                                    <option value="@edge.Price" price="@edge.Price">@edge.Height</option>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <select asp-for="OrderedMaterials[i].MaterialEdgeH2" class="form-control" onchange="calculateEdgePrice(@i);" />
                                <option value="0"></option>
                                @foreach (var edge in Model.Edges)
                                {
                                    <option value="@edge.Price">@edge.Height</option>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <select asp-for="OrderedMaterials[i].MaterialEdgeL1" class="form-control" onchange="calculateEdgePrice(@i);" />
                                <option value="0"></option>
                                @foreach (var edge in Model.Edges)
                                {
                                    <option value="@edge.Price">@edge.Length</option>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <select asp-for="OrderedMaterials[i].MaterialEdgeL2" class="form-control" onchange="calculateEdgePrice(@i);" />
                                <option value="0"></option>
                                @foreach (var edge in Model.Edges)
                                {
                                    <option value="@edge.Price">@edge.Length</option>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="form-group">
                                <input asp-for="OrderedMaterials[i].MaterialEdgeTotalPrice" class="form-control" disabled="disabled" />
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <br />

        <div class="mb-3" style="width: 300px;">
            <input class="btn btn-success mb-2 w-100 p-3 fw-bolw" type="submit" value="Създаване на заявка" style="font-weight: bold;font-size: larger;" />
        </div>
    </form>
</div>

<script>
    var rowMaterialPrice = [];
    var rowEdgePrice = [];

    function insertPrice(row) 
    {
        var materialName = document.getElementById("OrderedMaterials_" + row + "__MaterialName");
        var materialPrice = document.getElementById("OrderedMaterials_" + row + "__MaterialPrice");

        materialPrice.value = parseF(materialName.value);
    }

    function calculateMaterialPrice(row)
    {
        var length = document.getElementById("OrderedMaterials_" + row + "__MaterialLength");
        var height = document.getElementById("OrderedMaterials_" + row + "__MaterialHeight");
        var quantity = document.getElementById("OrderedMaterials_" + row + "__MaterialQty");

        length.value = parseF(length.value);
        height.value = parseF(height.value);
        quantity.value = parseF(quantity.value);

        if (length.value != 0 && height.value != 0 && quantity.value != 0)
        {
            var quadrature = document.getElementById("OrderedMaterials_" + row + "__MaterialQuadrature");
            quadrature.value = ((length.value * height.value) * quantity.value).toFixed(3);

            var materialPrice = document.getElementById("OrderedMaterials_" + row + "__MaterialPrice");            

            var materialTotalPrice = document.getElementById("OrderedMaterials_" + row + "__MaterialTotalPrice");
            materialTotalPrice.value = (quadrature.value * parseF(materialPrice.options[materialPrice.selectedIndex].text)).toFixed(2);

            rowMaterialPrice[row] = materialTotalPrice.value;

            calculateMaterialTotalPrice();
        }
    }

    function calculateEdgePrice(row)
    {
        var quantity = document.getElementById("OrderedMaterials_" + row + "__MaterialQty");
        var totalPrice = document.getElementById("OrderedMaterials_" + row + "__MaterialEdgeTotalPrice");

        var h1 = document.getElementById("OrderedMaterials_" + row + "__MaterialEdgeH1");
        var h2 = document.getElementById("OrderedMaterials_" + row + "__MaterialEdgeH2");
        var l1 = document.getElementById("OrderedMaterials_" + row + "__MaterialEdgeL1");
        var l2 = document.getElementById("OrderedMaterials_" + row + "__MaterialEdgeL2");

        totalPrice.value = ((parseF(h1.value) + parseF(h2.value) + parseF(l1.value) + parseF(l2.value)) * parseF(quantity.value)).toFixed(2);

        rowEdgePrice[row] = totalPrice.value;
        calculateEdgeTotalPrice();
    }

    function calculateMaterialTotalPrice()
    {
        let sum = 0;

        for (let i = 0; i < 12; i++)
        {
            if (!isNaN(rowMaterialPrice[i])) 
            {
                sum += Number(rowMaterialPrice[i]);
            }
        }

        let materialPriceField = document.getElementById("MaterialPrice");
        materialPriceField.value = sum.toFixed(2);

        calculateTotalPrice();
    }

    function calculateEdgeTotalPrice() {
        let sum = 0;

        for (let i = 0; i < 12; i++) {
            if (!isNaN(rowEdgePrice[i])) {
                sum += Number(rowEdgePrice[i]);
            }
        }

        let edgePriceField = document.getElementById("EdgePrice");
        edgePriceField.value = sum.toFixed(2);

        calculateTotalPrice();
    }

    function calculateTotalPrice()
    {
        let sum = 0;

        for (let i = 0; i < 12; i++) {
            if (!isNaN(rowMaterialPrice[i])) 
            {
                sum += Number(rowMaterialPrice[i]);
            }

            if (!isNaN(rowEdgePrice[i])) 
            {
                sum += Number(rowEdgePrice[i]);
            }
        }

        let totalPriceField = document.getElementById("TotalPrice");
        totalPriceField.value = sum.toFixed(2);
    }

    function parseF(value) 
    {
        return parseFloat(value.replace(',', '.').replace(' ', ''));
    }
</script>